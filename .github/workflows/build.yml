name: Build macOS

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    name: Build on macOS
    # On force macos-13 (Intel) pour plus de compatibilité si tu ne veux pas gérer l'ARM tout de suite
    # Sinon utilise 'macos-latest' pour les puces M1/M2/M3
    runs-on: macos-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          # On passe à 6.6.2 qui est plus stable sur les Mac récents
          version: '6.6.2'
          host: 'mac'
          target: 'desktop'
          # IMPORTANT : On installe les modules audio/vidéo
          modules: 'qtmultimedia qt5compat'
          
      - name: Installation de FFmpeg (via Homebrew)
        run: |
          brew update
          brew install ffmpeg

      - name: Compilation (Build)
        run: |
          # Création du Makefile
          qmake son_fusion.pro CONFIG+=release
          # Compilation
          make -j$(sysctl -n hw.ncpu)

      - name: Création du paquet (Deploy)
        run: |
          # Créer dossier temporaire
          mkdir -p deploy
          cp -r son_fusion.app deploy/
          
          # Préparer les dossiers dans le .app
          mkdir -p deploy/son_fusion.app/Contents/MacOS
          
          # Trouver où brew a installé ffmpeg et le copier
          FFMPEG_BIN=$(brew --prefix ffmpeg)/bin
          cp "$FFMPEG_BIN/ffmpeg" deploy/son_fusion.app/Contents/MacOS/
          cp "$FFMPEG_BIN/ffprobe" deploy/son_fusion.app/Contents/MacOS/
          
          # Rendre exécutable
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffmpeg
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffprobe
          
          # Utiliser l'outil Qt pour finir le travail (libs + dmg)
          macdeployqt deploy/son_fusion.app -dmg -verbose=2
          
          # Renommer pour être clair
          mv deploy/son_fusion.dmg SonFusion_macOS.dmg

      - name: Sauvegarder le DMG (Artifact)
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-macOS
          path: SonFusion_macOS.dmg
