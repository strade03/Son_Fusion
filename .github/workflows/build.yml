name: Build Multi-Platform

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  # =========================================================
  # JOB MACOS (Celui que tu avais déjà, légèrement optimisé)
  # =========================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'mac'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'
          
      - name: Installation de FFmpeg
        run: |
          brew update
          brew install ffmpeg

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Création du DMG
        run: |
          mkdir -p deploy
          cp -r son_fusion.app deploy/
          
          mkdir -p deploy/son_fusion.app/Contents/MacOS
          
          # Copie de FFmpeg installé par Brew
          FFMPEG_BIN=$(brew --prefix ffmpeg)/bin
          cp "$FFMPEG_BIN/ffmpeg" deploy/son_fusion.app/Contents/MacOS/
          cp "$FFMPEG_BIN/ffprobe" deploy/son_fusion.app/Contents/MacOS/
          
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffmpeg
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffprobe
          
          macdeployqt deploy/son_fusion.app -dmg -verbose=2
          mv deploy/son_fusion.dmg SonFusion_macOS.dmg

      - name: Upload Artifact macOS
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-macOS
          path: SonFusion_macOS.dmg

  # =========================================================
  # JOB LINUX (Nouveau !)
  # =========================================================
  build-linux:
    name: Build Linux (AppImage)
    # Ubuntu 22.04 est un bon compromis pour la compatibilité (Debian 11+, etc.)
    runs-on: ubuntu-22.04 
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'

      - name: Installation des dépendances Linux
        run: |
          sudo apt-get update
          
          # FIX : Installer libunwind-dev en premier pour éviter le conflit "held broken packages"
          sudo apt-get install -y libunwind-dev
          
          # Installation des libs graphiques, audio et FFmpeg
          sudo apt-get install -y build-essential libgl1-mesa-dev libxkbcommon-x11-0 \
            libpulse-dev libasound2-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-0 libgstreamer-plugins-bad1.0-0 \
            ffmpeg libxcb-cursor0

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(nproc)

      - name: Création de l'AppImage
        run: |
          # 1. Télécharger l'outil linuxdeployqt
          wget https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

          # 2. Préparer le dossier pour l'AppImage
          # On crée un fichier .desktop temporaire nécessaire pour l'AppImage
          cat > default.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=SonFusion
          Exec=son_fusion
          Icon=default
          Categories=AudioVideo;Audio;
          EOF
          
          # On a besoin d'une icône par défaut (on en crée une fausse si tu n'en as pas)
          touch default.png

          # 3. Lancer le déploiement
          # On unset QT_PLUGIN_PATH pour éviter les conflits avec le système
          unset QT_PLUGIN_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH
          
          # Note: -unsupported-allow-new-glibc est souvent nécessaire sur les GitHub Runners récents
          ./linuxdeployqt-continuous-x86_64.AppImage ./son_fusion -appimage -unsupported-allow-new-glibc -extra-plugins=iconengines,platformthemes

          # 4. Renommer le fichier de sortie
          mv SonFusion-*.AppImage SonFusion_Linux.AppImage

      - name: Upload Artifact Linux
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-Linux
          path: SonFusion_Linux.AppImage
