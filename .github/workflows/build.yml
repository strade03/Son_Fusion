name: Build Multi-Platform

on:
  push:
    branches: [ main ]
    # Optimisation : On ne lance pas le build si on modifie juste la doc
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'images/**'
      - '**/*.txt'
  pull_request:
    branches: [ main ]

jobs:
  # =========================================================
  # JOB MACOS
  # =========================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2' # Version stable CI
          host: 'mac'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'
          
      - name: Installation de FFmpeg
        run: |
          brew update
          brew install ffmpeg

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Création du DMG
        run: |
          mkdir -p deploy
          cp -r son_fusion.app deploy/
          
          mkdir -p deploy/son_fusion.app/Contents/MacOS
          
          # On récupère le FFmpeg installé par GitHub (plus sûr que le fichier local)
          FFMPEG_BIN=$(brew --prefix ffmpeg)/bin
          cp "$FFMPEG_BIN/ffmpeg" deploy/son_fusion.app/Contents/MacOS/
          cp "$FFMPEG_BIN/ffprobe" deploy/son_fusion.app/Contents/MacOS/
          
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffmpeg
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffprobe
          
          # MacDeployQt crée le bundle autonome + le DMG
          macdeployqt deploy/son_fusion.app -dmg -verbose=2
          
          mv deploy/son_fusion.dmg SonFusion_macOS.dmg

      - name: Upload Artifact macOS
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-macOS
          path: SonFusion_macOS.dmg

  # =========================================================
  # JOB LINUX (AppImage)
  # =========================================================
  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-22.04 
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'

      - name: Installation des dépendances Linux
        run: |
          sudo apt-get update
          
          # FIX CRITIQUE : Installer libunwind-dev en premier pour éviter les conflits
          sudo apt-get install -y libunwind-dev

          # Installation des libs graphiques, Gstreamer (audio) et outils
          sudo apt-get install -y build-essential libgl1-mesa-dev libxkbcommon-x11-0 \
            libpulse-dev libasound2-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-0 libgstreamer-plugins-bad1.0-0 \
            ffmpeg libxcb-cursor0 libxcb-xinerama0

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(nproc)

      - name: Création de l'AppImage
        run: |
          # 1. Télécharger l'outil de déploiement
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

          # 2. Créer un fichier .desktop minimal pour l'outil
          cat > default.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=SonFusion
          Exec=son_fusion
          Icon=default
          Categories=AudioVideo;Audio;
          EOF
          
          # Icône temporaire si absente
          touch default.png

          # 3. Lancer la création du paquet portable
          unset QT_PLUGIN_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH
          
          # -unsupported-allow-new-glibc est nécessaire sur Ubuntu 22.04+
          ./linuxdeployqt-continuous-x86_64.AppImage ./son_fusion -appimage -unsupported-allow-new-glibc -extra-plugins=iconengines,platformthemes

          # 4. Renommer
          mv SonFusion-*.AppImage SonFusion_Linux.AppImage

      - name: Upload Artifact Linux
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-Linux
          path: SonFusion_Linux.AppImage
