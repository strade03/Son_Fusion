name: Build Multi-Platform

on:
  push:
    branches: [ main ]
    # Optimisation : On ne lance pas le build si on modifie juste la doc
    paths-ignore:
      - 'README.md'
      - 'docs/**'
      - '.gitignore'
      - 'LICENSE'
      - 'images/**'
      - '**/*.txt'
  pull_request:
    branches: [ main ]

jobs:
  # =========================================================
  # JOB MACOS
  # =========================================================
  build-macos:
    name: Build macOS
    runs-on: macos-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2' # Version stable CI
          host: 'mac'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'
          
      - name: Installation de FFmpeg
        run: |
          brew update
          brew install ffmpeg

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(sysctl -n hw.ncpu)

      - name: Création du paquet et Signature
        run: |
          mkdir -p deploy
          cp -r son_fusion.app deploy/
          
          mkdir -p deploy/son_fusion.app/Contents/MacOS
          
          # 1. Copie de FFmpeg
          FFMPEG_BIN=$(brew --prefix ffmpeg)/bin
          cp "$FFMPEG_BIN/ffmpeg" deploy/son_fusion.app/Contents/MacOS/
          cp "$FFMPEG_BIN/ffprobe" deploy/son_fusion.app/Contents/MacOS/
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffmpeg
          chmod +x deploy/son_fusion.app/Contents/MacOS/ffprobe
          
          # 2. On utilise macdeployqt UNIQUEMENT pour copier les librairies Qt (pas de dmg, pas de sign)
          macdeployqt deploy/son_fusion.app -verbose=2
          
          # 3. SIGNATURE MANUELLE (La méthode infaillible)
          # --force : écrase les signatures existantes
          # --deep : signe aussi les frameworks Qt et FFmpeg à l'intérieur
          # - : signature ad-hoc (sans certificat payant)
          codesign --force --deep --sign - deploy/son_fusion.app
          
          # 4. Création du DMG avec l'outil Apple (hdiutil) au lieu de Qt
          # Cela garantit que le fichier signé reste intact
          hdiutil create -volname "SonFusion" -srcfolder deploy/son_fusion.app -ov -format UDZO deploy/son_fusion.dmg
          
          # Renommage pour l'artifact
          mv deploy/son_fusion.dmg SonFusion_macOS.dmg

  # =========================================================
  # JOB LINUX (AppImage)
  # =========================================================
  build-linux:
    name: Build Linux (AppImage)
    runs-on: ubuntu-22.04 
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          host: 'linux'
          target: 'desktop'
          modules: 'qtmultimedia qt5compat'

      - name: Installation des dépendances Linux
        run: |
          sudo apt-get update
          
          # FIX CRITIQUE : Installer libunwind-dev en premier pour éviter les conflits
          sudo apt-get install -y libunwind-dev

          # Installation des libs graphiques, Gstreamer (audio) et outils
          sudo apt-get install -y build-essential libgl1-mesa-dev libxkbcommon-x11-0 \
            libpulse-dev libasound2-dev \
            libgstreamer1.0-dev libgstreamer-plugins-base1.0-dev \
            libgstreamer-plugins-good1.0-0 libgstreamer-plugins-bad1.0-0 \
            ffmpeg libxcb-cursor0 libxcb-xinerama0

      - name: Compilation
        run: |
          qmake son_fusion.pro CONFIG+=release
          make -j$(nproc)

      - name: Création de l'AppImage
        run: |
          # 1. Télécharger l'outil de déploiement
          wget -q https://github.com/probonopd/linuxdeployqt/releases/download/continuous/linuxdeployqt-continuous-x86_64.AppImage
          chmod +x linuxdeployqt-continuous-x86_64.AppImage

          # 2. Créer un fichier .desktop minimal pour l'outil
          cat > default.desktop <<EOF
          [Desktop Entry]
          Type=Application
          Name=SonFusion
          Exec=son_fusion
          Icon=default
          Categories=AudioVideo;Audio;
          EOF
          
          # Icône temporaire si absente
          touch default.png

          # 3. Lancer la création du paquet portable
          unset QT_PLUGIN_PATH
          export LD_LIBRARY_PATH=$LD_LIBRARY_PATH
          
          # -unsupported-allow-new-glibc est nécessaire sur Ubuntu 22.04+
          ./linuxdeployqt-continuous-x86_64.AppImage ./son_fusion -appimage -unsupported-allow-new-glibc -extra-plugins=iconengines,platformthemes

          # 4. Renommer
          mv SonFusion-*.AppImage SonFusion_Linux.AppImage

      - name: Upload Artifact Linux
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-Linux
          path: SonFusion_Linux.AppImage

# =========================================================
  # JOB WINDOWS (MSVC)
  # =========================================================
  build-windows:
    name: Build Windows (MSVC)
    runs-on: windows-latest
    
    steps:
      - name: Checkout du code
        uses: actions/checkout@v4

      - name: Installation de Qt
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.6.2'
          arch: win64_msvc2019_64 # Compatible avec VS2022
          modules: 'qtmultimedia qt5compat'

      - name: Téléchargement de FFmpeg (Windows)
        shell: pwsh
        run: |
          # On télécharge la version officielle (gyan.dev)
          $url = "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          $output = "ffmpeg.zip"
          Invoke-WebRequest -Uri $url -OutFile $output
          
          # On décompresse
          Expand-Archive $output -DestinationPath .
          
          # On prépare un dossier 'bin_win' propre
          New-Item -ItemType Directory -Force -Path bin_win
          
          # On déplace les .exe au bon endroit (le nom du dossier change selon la version, d'où le wildcard *)
          Move-Item ffmpeg-*-essentials_build/bin/ffmpeg.exe bin_win/
          Move-Item ffmpeg-*-essentials_build/bin/ffprobe.exe bin_win/

      - name: Configuration de l'environnement MSVC
        uses: ilammy/msvc-dev-cmd@v1

      - name: Compilation
        shell: cmd
        run: |
          :: Configuration Release
          qmake son_fusion.pro CONFIG+=release
          :: Compilation avec nmake (inclus avec VS)
          nmake

      - name: Création du paquet (Deploy)
        shell: pwsh
        run: |
          # Créer le dossier de déploiement
          New-Item -ItemType Directory -Force -Path deploy
          
          # Copier l'exécutable compilé
          # Note: qmake met souvent l'exe dans release/
          if (Test-Path "release/son_fusion.exe") {
              Copy-Item "release/son_fusion.exe" "deploy/"
          } else {
              Copy-Item "son_fusion.exe" "deploy/"
          }
          
          # Copier FFmpeg/FFprobe
          Copy-Item "bin_win/ffmpeg.exe" "deploy/"
          Copy-Item "bin_win/ffprobe.exe" "deploy/"
          
          # Copier le dossier icones s'il existe
          if (Test-Path "icones") {
              Copy-Item -Path "icones" -Destination "deploy/icones" -Recurse
          }

          # Outil magique Qt pour copier les DLLs
          windeployqt --release --compiler-runtime --no-translations deploy/son_fusion.exe
          
          # Créer le ZIP final
          Compress-Archive -Path "deploy/*" -DestinationPath "SonFusion_Windows.zip"

      - name: Upload Artifact Windows
        uses: actions/upload-artifact@v4
        with:
          name: SonFusion-Windows
          path: SonFusion_Windows.zip        
