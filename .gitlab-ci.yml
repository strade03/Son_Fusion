stages:
  - build

variables:
  QT_VERSION: "6.5.0"
  APP_VERSION: "2.1"

build:macos:
  stage: build
  tags:
    - macos  # À changer selon ton runner (ex: saas-macos-medium-m1)
  script:
    # 1. Compilation
    - qmake son_fusion.pro CONFIG+=release
    - make -j$(sysctl -n hw.ncpu)
    
    # 2. Préparation déploiement
    - mkdir -p deploy_macos
    - cp -r son_fusion.app deploy_macos/
    
    # 3. Copie FFmpeg depuis TES sources (bin/mac) vers le Bundle
    - cp bin/mac/ffmpeg deploy_macos/son_fusion.app/Contents/MacOS/
    #- cp bin/mac/ffprobe deploy_macos/son_fusion.app/Contents/MacOS/
    - chmod +x deploy_macos/son_fusion.app/Contents/MacOS/ffmpeg
    #- chmod +x deploy_macos/son_fusion.app/Contents/MacOS/ffprobe
    
    # 4. MacDeployQt (Embarque les libs Qt et crée le DMG)
    # Note: macdeployqt est inclus avec Qt, pas besoin de create-dmg sauf si design spécifique
    - macdeployqt deploy_macos/son_fusion.app -dmg -verbose=2
    
    # 5. Renommage
    - mv deploy_macos/son_fusion.dmg SonFusion_v${APP_VERSION}_macOS.dmg

  artifacts:
    paths:
      - SonFusion_v${APP_VERSION}_macOS.dmg
    expire_in: 1 week
